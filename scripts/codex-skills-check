#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
CATALOG_DIR="${REPO_ROOT}/.agents/skills"

if [[ ! -d "${CATALOG_DIR}" ]]; then
  echo "Catalog not found: ${CATALOG_DIR}" >&2
  exit 1
fi

echo "Codex skills catalog: ${CATALOG_DIR}"
echo

for skill_md in "${CATALOG_DIR}"/*/SKILL.md; do
  [[ -f "${skill_md}" ]] || continue
  skill_dir="$(dirname "${skill_md}")"
  meta_file="${skill_dir}/agents/openai.yaml"
  skill_name="$(sed -n 's/^name:[[:space:]]*//p' "${skill_md}" | head -n 1)"
  skill_desc="$(sed -n 's/^description:[[:space:]]*//p' "${skill_md}" | head -n 1)"
  implicit_policy="(not set)"
  if [[ -f "${meta_file}" ]]; then
    implicit_policy="$(sed -n 's/^allow_implicit_invocation:[[:space:]]*//p' "${meta_file}" | head -n 1)"
    [[ -n "${implicit_policy}" ]] || implicit_policy="(not set)"
  fi

  echo "skill: ${skill_name:-unknown}"
  echo "  path: ${skill_md}"
  echo "  implicit: ${implicit_policy}"
  echo "  description: ${skill_desc:-n/a}"
  echo
done
